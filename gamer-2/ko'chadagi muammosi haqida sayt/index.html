<!doctype html>
<html lang="uz">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ko'chadagi muammolar — Tirbandlik va Svetaforlar Yechimi</title>
    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Lottie for lightweight animations (optional) -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        /* Basic reset + layout */
        :root {
            --accent: #0b7285;
            --bg: #f7fbfc;
            --card: #ffffff
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, Arial;
            background: var(--bg);
            color: #0f172a
        }

        header {
            height: 260px;
            background: linear-gradient(180deg, rgba(11, 114, 133, 0.12), transparent), url('https://images.unsplash.com/photo-1508057198894-247b23fe5ade?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=') center/cover no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden
        }

        .hero-inner {
            width: 100%;
            max-width: 1100px;
            padding: 24px;
            display: flex;
            gap: 20px;
            align-items: center
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent)
        }

        .subtitle {
            margin-top: 8px;
            color: #334155
        }

        main {
            max-width: 1200px;
            margin: -60px auto 40px;
            padding: 20px
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 18px
        }

        .card {
            background: var(--card);
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(16, 24, 40, 0.06)
        }

        #map {
            height: 640px;
            border-radius: 10px
        }

        form .row {
            display: flex;
            gap: 8px
        }

        label {
            font-size: 13px;
            color: #334155
        }

        input[type=text],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e6eef3
        }

        button {
            background: var(--accent);
            color: white;
            padding: 10px 12px;
            border: 0;
            border-radius: 8px;
            cursor: pointer
        }

        .list {
            max-height: 300px;
            overflow: auto;
            margin-top: 10px
        }

        .report-item {
            padding: 8px;
            border-bottom: 1px dashed #e6eef3
        }

        footer {
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px;
            color: #64748b;
            text-align: center
        }

        @media(max-width:900px) {
            .grid {
                grid-template-columns: 1fr
            }

            .hero-inner {
                flex-direction: column
            }

            .subtitle {
                font-size: 14px
            }
        }
    </style>
</head>

<body>
    <header
        style="background-image: url(./img/tirbandlik.jpg); background-repeat: no-repeat; background-size: 1600px;background-position-y: center;">
        <div class="heador" style="display: flex; flex-direction: column; padding: 20px; background-color: yellow;border-radius: 8px;">
            <a style="color: rgb(255, 0, 0); border-radius: 8px; border:3px solid #9ac50f; text-decoration: none;" href="#map">Xarita</a>
            <a style="color: rgb(255, 0, 0); text-decoration: none; margin-top: 20px;border-radius: 8px; border:3px solid #9ac50f;" href="#so'ng">So'ngi xabarlar</a>
        </div>
        <div class="hero-inner">
            <div style="flex:1">
                <div class="title" style="color: aqua;">Ko'chadagi muammolar — Tirbandlik va Svetafor buzilishi</div>
                <div class="subtitle" style="color:greenyellow;">Foydalanuvchilar shikoyat qilgan joylarni xaritada
                    ko'ring, tirbandlik signalizatsiyasi va svetaforlar holatini kuzatib yechim taklif qiling.</div>
            </div>
            <div style="width:160px;height:160px">
                <lottie-player src="https://assets2.lottiefiles.com/packages/lf20_tll0j4bb.json"
                    background="transparent" speed="1" loop autoplay></lottie-player>
            </div>
        </div>
    </header>

    <main>
        <div class="grid">
            <div class="card">
                <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
                    <strong>Xarita</strong>
                    <small style="color:#64748b">(GPS orqali markazlang — demo uchun localhostda ishlaydi)</small>
                </div>
                <div id="map"></div>
            </div>

            <div>
                <div class="card">
                    <h3 style="margin:0 0 8px 0">Yangi muammo habar berish</h3>
                    <form id="reportForm">
                        <div class="row" style="margin-bottom:8px">
                            <div style="flex:1">
                                <label for="type">Muammo turi</label>
                                <select id="type">
                                    <option value="congestion">Tirbandlik / Jamoat transporti to'xtashi</option>
                                    <option value="traffic_light">Svetafor ishsiz</option>
                                    <option value="hazard">Xavf / to'siq</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom:8px">
                            <label for="title">Qisqacha tavsif</label>
                            <input id="title" type="text" placeholder="Masalan: Toshkent sh. A. Qodiriy ko'chasi"
                                required />
                        </div>
                        <div style="margin-bottom:8px">
                            <label for="desc">Batafsil ma'lumot</label>
                            <textarea id="desc" rows="3"
                                placeholder="Trafik qanchalik qiyin, qaysi yo'nalish..."></textarea>
                        </div>
                        <div style="display:flex;gap:8px;margin-bottom:8px">
                            <button id="useLocation" type="button">Manzilni oling (GPS)</button>
                            <button type="submit">Jo'natish</button>
                        </div>
                        <div style="font-size:12px;color:#475569">Agar GPS mavjud bo'lmasa, xaritada marker qo'ying.
                        </div>
                    </form>
                </div>

                <div class="card" style="margin-top:12px">
                    <h3 id="so'ng" style="margin:0 0 8px 0">So'nggi xabarlar</h3>
                    <div class="list" id="reportsList"></div>
                    <div style="display:flex;gap:8px;margin-top:10px">
                        <button id="exportJSON" type="button">Export JSON</button>
                        <button id="clearAll" type="button" style="background:#ef4444">Hammasini o'chirish</button>
                    </div>
                </div>

                <div class="card" style="margin-top:12px">
                    <h3 style="margin:0 0 8px 0">Admin / Analitika (demo)</h3>
                    <div id="analytics">Tirbandlik aniqlash: <strong id="congestionCount">0</strong> ta joy</div>
                    <div style="margin-top:8px;font-size:13px;color:#475569">Qoidalar: 3 yoki undan ortiq yaqin joylarda
                        bir xil turdagi xabar tirbandlik sifatida belgilanadi.</div>
                </div>

            </div>
        </div>
    </main>

    <footer>Sayt demo — bu kodni hostingga yuklab, server (API) qo'shish orqali real monitoringga aylantirish mumkin.
    </footer>

    <script>
        // Demo: localStorage orqali saqlash va Leaflet xaritasi
        const STORAGE_KEY = 'street_reports_v1';
        let reports = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

        // Initialize map
        const map = L.map('map', { scrollWheelZoom: true }).setView([41.311081, 69.240562], 12); // default Toshkent
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // marker layer group
        const markers = L.layerGroup().addTo(map);

        function iconForType(t) {
            const colors = { congestion: 'orange', traffic_light: 'red', hazard: 'gray' };
            const c = colors[t] || 'blue';
            return L.divIcon({ className: 'custom-marker', html: `<div style="background:${c};width:18px;height:18px;border-radius:50%;border:2px solid white"></div>`, iconSize: [18, 18], iconAnchor: [9, 9] });
        }

        // render reports
        function renderReports() {
            markers.clearLayers();
            const list = document.getElementById('reportsList');
            list.innerHTML = '';
            reports.forEach((r, idx) => {
                const el = document.createElement('div'); el.className = 'report-item';
                el.innerHTML = `<strong>${r.title}</strong> <div style="font-size:12px;color:#475569">${r.type} • ${new Date(r.time).toLocaleString()}</div><div style="margin-top:6px">${r.desc || ''}</div>`;
                list.appendChild(el);
                if (r.lat && r.lng) {
                    const m = L.marker([r.lat, r.lng], { icon: iconForType(r.type) }).addTo(markers);
                    m.bindPopup(`<strong>${r.title}</strong><div style="font-size:13px">${r.desc || ''}</div><div style="font-size:12px;color:#64748b;margin-top:6px">${new Date(r.time).toLocaleString()}</div>`);
                }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
            updateAnalytics();
        }

        function updateAnalytics() {
            // simple congestion detection: cluster density heuristic
            const congestionReports = reports.filter(r => r.type === 'congestion');
            document.getElementById('congestionCount').textContent = congestionReports.length;
            // If >=3 congestion reports are within 500m of each other -> notify
            const flagged = [];
            for (let i = 0; i < congestionReports.length; i++) {
                const a = congestionReports[i];
                let nearby = 0;
                for (let j = 0; j < congestionReports.length; j++) {
                    if (i === j) continue;
                    const b = congestionReports[j];
                    if (!a.lat || !b.lat) continue;
                    const d = map.distance([a.lat, a.lng], [b.lat, b.lng]);
                    if (d < 500) nearby++;
                }
                if (nearby >= 2) flagged.push(a);
            }
            if (flagged.length > 0) {
                // visual browser notification (if allowed) + small alert box
                if (Notification && Notification.permission === 'granted') {
                    new Notification('Tirbandlik aniqlandi', { body: flagged[0].title });
                }
                // flash header
                document.querySelector('header').style.border = '4px solid #f97316';
                setTimeout(() => document.querySelector('header').style.border = '0', 5000);
            }
        }

        // click-to-place marker
        let tempMarker = null;
        map.on('click', function (e) {
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
            tempMarker.bindPopup('Xabar yuborish uchun <strong>Manzilni oling</strong> tugmasini ishlating yoki formani to' + "'" + 'ldiring va Jo\'natish tugmasini bosing.').openPopup();
            // store lat/lng in form fields
            tempMarker.on('move', () => {
                const p = tempMarker.getLatLng();
                tempLat = p.lat; tempLng = p.lng;
            });
            const p = e.latlng; tempLat = p.lat; tempLng = p.lng;
        });

        // form handling
        const form = document.getElementById('reportForm');
        let tempLat = null, tempLng = null;
        document.getElementById('useLocation').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude: lat, longitude: lng } = pos.coords; map.setView([lat, lng], 16);
                    if (tempMarker) map.removeLayer(tempMarker);
                    tempMarker = L.marker([lat, lng], { draggable: true }).addTo(map);
                    tempLat = lat; tempLng = lng;
                }, err => {
                    alert('GPSga ruxsat berilmagan yoki mavjud emas. Xaritada joy belgilang.');
                }, { enableHighAccuracy: true, timeout: 8000 });
            } else alert('Brauzeringiz geolokatsiyani qollamaydi.');
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const type = document.getElementById('type').value;
            const title = document.getElementById('title').value.trim();
            const desc = document.getElementById('desc').value.trim();
            const now = Date.now();
            const r = { id: 'r' + now, type, title, desc, time: now, lat: tempLat, lng: tempLng };
            reports.unshift(r);
            renderReports();
            alert('Xabaringiz qabul qilindi — rahmat!');
            form.reset(); tempLat = null; tempLng = null;
            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
        });

        document.getElementById('exportJSON').addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(reports, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'reports.json'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('clearAll').addEventListener('click', () => {
            if (confirm('Hamma xabarlarni o\'chirmoqchimisiz?')) { reports = []; renderReports(); }
        });

        // Ask for Notification permission (non-blocking)
        if ('Notification' in window && Notification.permission !== 'granted') {
            Notification.requestPermission().then(() => { });
        }

        // Load initial demo markers (if none exist, create a couple sample points)
        if (reports.length === 0) {
            reports.push({ id: 'demo1', type: 'congestion', title: 'Sayohat markazi — Tirbandlik', desc: 'Sharoit qiyin, kechikishlar', time: Date.now() - 1000 * 60 * 60, lat: 41.312, lng: 69.275 });
            reports.push({ id: 'demo2', type: 'traffic_light', title: 'Svetafor ishsiz', desc: 'Svetafor toxtadi — kop avtotransport', time: Date.now() - 1000 * 60 * 20, lat: 41.299, lng: 69.237 });
        }

        renderReports();

        // Periodic check (simulate incoming reports from server)
        setInterval(() => {
            // simple simulator: randomly add a report 5% chance
            if (Math.random() < 0.05) {
                const lat = 41.28 + Math.random() * 0.06;
                const lng = 69.20 + Math.random() * 0.08;
                const types = ['congestion', 'traffic_light', 'hazard'];
                const t = types[Math.floor(Math.random() * types.length)];
                reports.unshift({ id: 'sim' + Date.now(), type: t, title: 'Avtomatik: ' + t, desc: 'Simulyatsiya xabari', time: Date.now(), lat, lng });
                // keep size reasonable
                if (reports.length > 200) reports.pop();
                renderReports();
            }
        }, 8000);

        // Helpful tips for production (display in console)
        console.info(`Demo sayt: 1) To'g'ri ishlashi uchun backend (API) kerak — har bir xabarni serverga yuboring.\n2) Svetafor monitoring uchun: city API yoki MQTT/IoT qurilmalar bilan integratsiya va real-time websocket kerak.\n3) Tirbandlikni aniqlash: statistik model + CCTV / mobile probe data qo'shing.\n4) Ushbu demo single-file HTML. Deploy uchun Netlify / Vercel / GitHub Pages ishlatish mumkin.`);
    </script>
</body>

</html>